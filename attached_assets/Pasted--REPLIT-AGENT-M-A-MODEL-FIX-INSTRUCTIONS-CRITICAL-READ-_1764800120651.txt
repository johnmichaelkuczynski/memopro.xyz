# REPLIT AGENT: M&A MODEL FIX INSTRUCTIONS

## CRITICAL: READ THIS ENTIRE DOCUMENT BEFORE WRITING ANY CODE

The current M&A model has **critical bugs** that must be fixed. This document contains **explicit, step-by-step instructions**. Do NOT deviate from these instructions. Do NOT make assumptions. Follow them exactly.

---

## BUG #1: ACQUIRER EPS IS BEING IGNORED

### The Problem
When the user provides an explicit EPS value like "currently earns three dollars and twenty cents per share," the model is IGNORING this input and instead calculating EPS from Revenue → EBITDA → Net Income → EPS.

This is WRONG. If the user provides EPS directly, USE THAT VALUE.

### The Fix

**Step 1:** In your input parsing logic, add explicit extraction for acquirer EPS:

```python
# REQUIRED: Extract acquirer EPS if explicitly provided
acquirer_eps_pattern = r'(?:earns?|EPS of|earnings per share of?)\s*\$?([\d.]+)'
acquirer_eps_match = re.search(acquirer_eps_pattern, user_input, re.IGNORECASE)
if acquirer_eps_match:
    acquirer_eps = float(acquirer_eps_match.group(1))
    # USE THIS VALUE DIRECTLY - DO NOT RECALCULATE
```

**Step 2:** In your Acquirer Standalone sheet, add conditional logic:

```python
# If user provided explicit EPS, use it
if acquirer_eps is not None:
    # Write the explicit EPS to Year 0
    ws['G5'] = acquirer_eps  # Assuming G5 is Year 0 EPS cell
    # For projections, grow from this base
else:
    # Only if NO explicit EPS provided, calculate from Net Income / Shares
    ws['G5'] = f'=G4/{shares_outstanding}'
```

**Step 3:** Add validation that FAILS if explicit EPS doesn't match calculated:

```python
if acquirer_eps is not None:
    calculated_eps = net_income / shares_outstanding
    if abs(calculated_eps - acquirer_eps) > 0.01:
        # Log warning but USE THE USER'S VALUE
        print(f"WARNING: User EPS ${acquirer_eps} differs from calculated ${calculated_eps:.2f}")
        print(f"USING USER-PROVIDED VALUE: ${acquirer_eps}")
```

### Verification Test
Input: "...currently earns three dollars and twenty cents per share on one hundred fifty million shares..."
Expected Output: Acquirer Standalone EPS Year 0 = $3.20
If output shows $2.02 or any other value, THE BUG IS NOT FIXED.

---

## BUG #2: SOURCES & USES DOES NOT BALANCE

### The Problem
Sources = $1,800M
Uses = $1,845M (includes $45M transaction fees)
Gap = $45M unfunded

This is a fundamental accounting error. Sources MUST equal Uses.

### The Fix

**Step 1:** Calculate total uses FIRST:

```python
total_uses = purchase_price + transaction_fees + (debt_assumed if debt_assumed else 0)
# Example: $1,800M + $45M + $0 = $1,845M
```

**Step 2:** Sources must fund total uses, not just purchase price:

```python
# WRONG:
cash_from_bs = 500  # arbitrary
new_debt = 580  # arbitrary  
stock = 720  # 40% of purchase price only
# Total = $1,800M -- DOES NOT COVER FEES

# CORRECT:
stock_consideration = purchase_price * stock_pct  # $720M
cash_consideration = purchase_price * cash_pct    # $1,080M
transaction_fees = 45
total_cash_needed = cash_consideration + transaction_fees  # $1,125M

# Now allocate cash sources to cover total cash needed
cash_from_balance_sheet = min(existing_cash, total_cash_needed)
new_debt_required = total_cash_needed - cash_from_balance_sheet
```

**Step 3:** Write balanced Sources & Uses:

```python
# SOURCES
ws['B3'] = cash_from_balance_sheet  # e.g., $545M
ws['B4'] = new_debt_required        # e.g., $580M
ws['B5'] = stock_consideration      # e.g., $720M
ws['B6'] = f'=SUM(B3:B5)'           # MUST equal $1,845M

# USES  
ws['B9'] = purchase_price           # $1,800M
ws['B10'] = debt_assumed            # $0
ws['B11'] = transaction_fees        # $45M
ws['B12'] = f'=SUM(B9:B11)'         # MUST equal $1,845M

# VALIDATION - ADD THIS CHECK
ws['B14'] = '=B6-B12'  # Should be exactly 0
ws['A14'] = 'Balance Check (must be 0):'
```

### Verification Test
Sources total MUST equal Uses total.
If there is ANY gap, THE BUG IS NOT FIXED.

---

## BUG #3: GOODWILL CALCULATION IS WRONG

### The Problem
Goodwill = $1,300M (model output)
Expected = $1,030M (correct calculation)

### The Correct Formula

```
Goodwill = Purchase Price 
         - Fair Value of Net Assets
         - Fair Value of Identified Intangibles

Goodwill = $1,800M - $450M - $200M - $120M = $1,030M
```

Where:
- Purchase Price = $1,800M
- Fair Value of Net Assets = $450M (given in input)
- Customer Relationships = $200M (identified intangible)
- Developed Technology = $120M (identified intangible)

### The Fix

**Step 1:** Extract ALL PPA components from input:

```python
# Parse PPA information
book_value_net_assets = extract_number(input, r'book value of (\$?[\d.]+)\s*(?:million|M)')
fair_value_net_assets = extract_number(input, r'fair value of (\$?[\d.]+)\s*(?:million|M)')
customer_relationships = extract_number(input, r'customer relationships.*?(\$?[\d.]+)\s*(?:million|M)')
customer_rel_life = extract_number(input, r'customer relationships.*?(\d+)[- ]year')
developed_tech = extract_number(input, r'developed technology.*?(\$?[\d.]+)\s*(?:million|M)')
developed_tech_life = extract_number(input, r'developed technology.*?(\d+)[- ]year')
```

**Step 2:** Calculate goodwill correctly:

```python
identified_intangibles = customer_relationships + developed_tech
goodwill = purchase_price - fair_value_net_assets - identified_intangibles

# Validation
if goodwill < 0:
    raise ValueError("Negative goodwill - check PPA inputs")
```

**Step 3:** Create PPA tab (currently missing):

```python
# Create Purchase Price Allocation worksheet
ws_ppa = wb.create_sheet('Purchase_Price_Allocation')

# Header
ws_ppa['A1'] = 'PURCHASE PRICE ALLOCATION'

# Purchase price
ws_ppa['A3'] = 'Purchase Price'
ws_ppa['B3'] = purchase_price

# Less: Fair value of net assets
ws_ppa['A5'] = 'Less: Fair Value of Identifiable Net Assets'
ws_ppa['B5'] = -fair_value_net_assets

# Less: Identified intangibles
ws_ppa['A6'] = 'Less: Customer Relationships'
ws_ppa['B6'] = -customer_relationships
ws_ppa['C6'] = f'{customer_rel_life} year life'

ws_ppa['A7'] = 'Less: Developed Technology'
ws_ppa['B7'] = -developed_tech
ws_ppa['C7'] = f'{developed_tech_life} year life'

# Goodwill (formula, not hardcoded)
ws_ppa['A9'] = 'Goodwill (Residual)'
ws_ppa['B9'] = '=B3+B5+B6+B7'  # Sum of positive and negatives

# Amortization schedule
ws_ppa['A12'] = 'INTANGIBLE AMORTIZATION SCHEDULE'
# ... add yearly amortization rows
```

### Verification Test
Goodwill = $1,800M - $450M - $200M - $120M = $1,030M
If output shows $1,300M or any other value, THE BUG IS NOT FIXED.

---

## BUG #4: MISSING REQUIRED TABS

### The Problem
The model is missing 4 required worksheets:
1. Purchase Price Allocation
2. Debt Schedule
3. Sensitivity Analysis
4. Charts

### The Fix

**CREATE TAB: Purchase_Price_Allocation**

```python
ws_ppa = wb.create_sheet('Purchase_Price_Allocation')

# Section 1: PPA Summary
ws_ppa['A1'] = 'PURCHASE PRICE ALLOCATION'
ws_ppa['A3'] = 'Purchase Price'
ws_ppa['B3'] = purchase_price  # Blue font - input

ws_ppa['A5'] = 'Book Value of Net Assets'
ws_ppa['B5'] = book_value_net_assets  # Blue font

ws_ppa['A6'] = 'Fair Value Step-Up'
ws_ppa['B6'] = '=B7-B5'  # Formula

ws_ppa['A7'] = 'Fair Value of Net Assets'
ws_ppa['B7'] = fair_value_net_assets  # Blue font

ws_ppa['A9'] = 'Identified Intangible Assets:'
ws_ppa['A10'] = '  Customer Relationships'
ws_ppa['B10'] = customer_relationships  # Blue font
ws_ppa['C10'] = customer_rel_life  # Years
ws_ppa['D10'] = '=B10/C10'  # Annual amortization

ws_ppa['A11'] = '  Developed Technology'
ws_ppa['B11'] = developed_tech  # Blue font
ws_ppa['C11'] = developed_tech_life  # Years
ws_ppa['D11'] = '=B11/C11'  # Annual amortization

ws_ppa['A12'] = '  Total Identified Intangibles'
ws_ppa['B12'] = '=B10+B11'

ws_ppa['A14'] = 'Goodwill'
ws_ppa['B14'] = '=B3-B7-B12'  # FORMULA - residual

# Section 2: Amortization Schedule
ws_ppa['A17'] = 'AMORTIZATION SCHEDULE'
ws_ppa['B17'] = 'Year 1'
ws_ppa['C17'] = 'Year 2'
# ... through Year 10

ws_ppa['A18'] = 'Customer Relationships'
for year in range(1, 11):
    col = chr(65 + year)  # B, C, D, etc.
    if year <= customer_rel_life:
        ws_ppa[f'{col}18'] = f'=$D$10'
    else:
        ws_ppa[f'{col}18'] = 0

ws_ppa['A19'] = 'Developed Technology'
for year in range(1, 6):
    col = chr(65 + year)
    if year <= developed_tech_life:
        ws_ppa[f'{col}19'] = f'=$D$11'
    else:
        ws_ppa[f'{col}19'] = 0

ws_ppa['A20'] = 'Total PPA Amortization'
for year in range(1, 11):
    col = chr(65 + year)
    ws_ppa[f'{col}20'] = f'={col}18+{col}19'
```

**CREATE TAB: Debt_Schedule**

```python
ws_debt = wb.create_sheet('Debt_Schedule')

ws_debt['A1'] = 'DEBT SCHEDULE'

# Inputs section
ws_debt['A3'] = 'New Debt Principal'
ws_debt['B3'] = new_debt_amount  # Blue font - $580M

ws_debt['A4'] = 'Interest Rate (SOFR + Spread)'
ws_debt['B4'] = interest_rate  # Blue font - 0.075 (7.5%)

ws_debt['A5'] = 'Annual Amortization Rate'
ws_debt['B5'] = amort_rate  # Blue font - 0.05 (5%)

ws_debt['A6'] = 'Maturity (Years)'
ws_debt['B6'] = maturity_years  # Blue font - 5

# Schedule headers
ws_debt['A9'] = 'Year'
ws_debt['B9'] = 'Beginning Balance'
ws_debt['C9'] = 'Mandatory Amortization'
ws_debt['D9'] = 'Optional Prepayment'
ws_debt['E9'] = 'Ending Balance'
ws_debt['F9'] = 'Interest Expense'

# Year 0 (closing)
ws_debt['A10'] = 0
ws_debt['B10'] = 0
ws_debt['C10'] = 0
ws_debt['D10'] = 0
ws_debt['E10'] = '=$B$3'  # New debt drawn
ws_debt['F10'] = 0

# Years 1-5
for year in range(1, 6):
    row = 10 + year
    ws_debt[f'A{row}'] = year
    ws_debt[f'B{row}'] = f'=E{row-1}'  # Beginning = prior ending
    ws_debt[f'C{row}'] = f'=$B$3*$B$5'  # Mandatory amort
    ws_debt[f'D{row}'] = 0  # Optional prepay (user can edit)
    ws_debt[f'E{row}'] = f'=B{row}-C{row}-D{row}'  # Ending balance
    ws_debt[f'F{row}'] = f'=(B{row}+E{row})/2*$B$4'  # Interest on avg balance

# Year 5 bullet
ws_debt['A16'] = 'Bullet Payment at Maturity'
ws_debt['B16'] = '=E15'  # Remaining balance
```

**CREATE TAB: Sensitivity_Analysis**

```python
ws_sens = wb.create_sheet('Sensitivity_Analysis')

ws_sens['A1'] = 'SENSITIVITY ANALYSIS'

# Table 1: Synergy Achievement vs Purchase Multiple
ws_sens['A4'] = 'Year 3 Accretion/Dilution'
ws_sens['A5'] = 'Synergy Achievement %'

# Column headers (purchase multiples)
multiples = [12, 13, 14, 15, 16, 17, 18]
for i, mult in enumerate(multiples):
    ws_sens.cell(row=4, column=3+i, value=f'{mult}x')

# Row headers (synergy achievement)
synergy_pcts = [0.6, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2]
for i, pct in enumerate(synergy_pcts):
    ws_sens.cell(row=6+i, column=2, value=f'{int(pct*100)}%')

# Data table formulas using Excel DATA TABLE function
# Note: This requires setting up a two-variable data table
# The intersection cell should reference Year 3 A/D from main model
ws_sens['C6'] = '=Accretion_Dilution!G5'  # Reference to Year 3 A/D %

# Add conditional formatting
from openpyxl.formatting.rule import ColorScaleRule
color_scale = ColorScaleRule(
    start_type='num', start_value=-0.1, start_color='FF0000',  # Red for dilutive
    mid_type='num', mid_value=0, mid_color='FFFFFF',  # White for breakeven
    end_type='num', end_value=0.3, end_color='00FF00'  # Green for accretive
)
ws_sens.conditional_formatting.add('C6:I12', color_scale)

# Table 2: Revenue Synergy vs Cost Synergy
ws_sens['A16'] = 'Year 3 Accretion/Dilution'
ws_sens['A17'] = 'Revenue Synergies ($M)'
# ... similar structure
```

**CREATE TAB: Charts**

```python
from openpyxl.chart import BarChart, LineChart, Reference

ws_charts = wb.create_sheet('Charts')

# Chart 1: Accretion/Dilution Waterfall
# (This requires careful setup - use bar chart with invisible connectors)

# Chart 2: Synergy Build
chart2 = BarChart()
chart2.type = 'col'
chart2.grouping = 'stacked'
chart2.title = 'Synergy Realization by Year'

# Reference synergies data
data = Reference(wb['Synergies'], min_col=2, max_col=7, min_row=1, max_row=4)
cats = Reference(wb['Synergies'], min_col=2, max_col=7, min_row=1)
chart2.add_data(data, titles_from_data=True)
chart2.set_categories(cats)

ws_charts.add_chart(chart2, 'A15')

# Chart 3: Combined Revenue & EBITDA
chart3 = BarChart()
chart3.title = 'Pro Forma Revenue & EBITDA'
# ... add data references from Pro_Forma_Combined

ws_charts.add_chart(chart3, 'A30')

# Chart 4: Debt Paydown
chart4 = LineChart()
chart4.title = 'Debt Balance Over Time'
# ... add data references from Debt_Schedule

ws_charts.add_chart(chart4, 'J15')
```

---

## BUG #5: REVENUE SYNERGY MARGIN NOT APPLIED

### The Problem
User specified "fifty percent flow-through margin on revenue synergies"
This means $40M revenue synergies → $20M EBITDA contribution
Model appears to add full $40M to EBITDA

### The Fix

**Step 1:** Extract revenue synergy margin from input:

```python
rev_syn_margin_pattern = r'(\d+)\s*(?:percent|%)\s*(?:flow[- ]?through|margin).*?revenue synerg'
rev_syn_margin_match = re.search(rev_syn_margin_pattern, user_input, re.IGNORECASE)
if rev_syn_margin_match:
    rev_synergy_margin = float(rev_syn_margin_match.group(1)) / 100  # 0.50
else:
    rev_synergy_margin = 1.0  # Default: 100% if not specified
```

**Step 2:** In Synergies tab, add EBITDA impact row:

```python
# Row for revenue synergies (top line)
ws_syn['A2'] = 'Revenue Synergies ($M)'
# ... values by year

# NEW ROW: EBITDA impact of revenue synergies
ws_syn['A3'] = 'Revenue Synergy EBITDA Impact ($M)'
ws_syn['B3'] = rev_synergy_margin  # Input assumption (blue)
for year in range(1, 6):
    col = chr(66 + year)  # C, D, E, F, G
    ws_syn[f'{col}3'] = f'={col}2*$B$3'  # Revenue × margin

# Cost synergies (already 100% EBITDA impact)
ws_syn['A4'] = 'Cost Synergies ($M)'

# Total EBITDA Synergies
ws_syn['A5'] = 'Total EBITDA Synergies'
for year in range(1, 6):
    col = chr(66 + year)
    ws_syn[f'{col}5'] = f'={col}3+{col}4'  # Rev EBITDA + Cost
```

**Step 3:** In Pro Forma Combined, reference EBITDA synergies (not revenue):

```python
# WRONG:
combined_ebitda = acquirer_ebitda + target_ebitda + revenue_synergies + cost_synergies

# CORRECT:
combined_ebitda = acquirer_ebitda + target_ebitda + ebitda_from_rev_synergies + cost_synergies
# Where ebitda_from_rev_synergies = revenue_synergies × flow_through_margin
```

### Verification Test
Year 3 EBITDA Synergies should be: ($40M × 50%) + $80M = $100M
NOT: $40M + $80M = $120M

---

## BUG #6: INTEREST EXPENSE NOT IN PRO FORMA

### The Problem
New debt of $580M at 7.5% = $43.5M annual interest
This must reduce Net Income and EPS in Pro Forma

### The Fix

```python
# In Pro_Forma_Combined sheet, add interest expense line

ws_pf['A5'] = 'Less: New Debt Interest'
for year in range(1, 6):
    col = chr(66 + year)  # C, D, E, F, G for Years 1-5
    # Reference debt schedule for interest
    ws_pf[f'{col}5'] = f'=-Debt_Schedule!F{10+year}'

# Net Income formula must include interest
ws_pf['A6'] = 'Pro Forma Net Income'
for year in range(1, 6):
    col = chr(66 + year)
    # Combined EBITDA - D&A - Interest - Taxes
    ws_pf[f'{col}6'] = f'=({col}3-{col}4+{col}5)*(1-tax_rate)'
```

---

## VALIDATION CHECKLIST

Before deploying ANY changes, verify ALL of the following:

### Input Fidelity Tests
- [ ] If user says "EPS of $3.20", Year 0 EPS cell shows $3.20
- [ ] If user says "150 million shares", shares outstanding = 150
- [ ] If user says "7.5% interest", debt schedule uses 7.5%

### Balance Tests  
- [ ] Sources & Uses totals are IDENTICAL (difference = $0.00)
- [ ] Pro Forma Balance Sheet balances (if included)

### Calculation Tests
- [ ] Goodwill = Purchase Price - FV Net Assets - Identified Intangibles
- [ ] Year 1 Cost Synergies = Run Rate × Phase-in %
- [ ] Revenue Synergy EBITDA = Revenue Synergies × Flow-through Margin
- [ ] Interest Expense = Debt Balance × Interest Rate

### Completeness Tests
- [ ] Tab exists: Executive Summary
- [ ] Tab exists: Sources & Uses
- [ ] Tab exists: Acquirer Standalone
- [ ] Tab exists: Target Standalone
- [ ] Tab exists: Synergies
- [ ] Tab exists: Pro Forma Combined
- [ ] Tab exists: Accretion Dilution
- [ ] Tab exists: Purchase Price Allocation
- [ ] Tab exists: Debt Schedule
- [ ] Tab exists: Sensitivity Analysis
- [ ] Tab exists: Charts

### Formula Tests
- [ ] NO hardcoded values in calculation cells
- [ ] All blue-font cells can be edited and model recalculates
- [ ] Accretion/Dilution updates when synergies change
- [ ] Sensitivity table updates when base assumptions change

---

## TEST CASE FOR VALIDATION

Use this EXACT input to test your fixes:

```
Build me an M&A model for TechCore Solutions acquiring DataFlow Analytics. TechCore is the acquirer with annual revenue of two billion four hundred million dollars, EBITDA of four hundred eighty million, and currently earns three dollars and twenty cents per share on one hundred fifty million fully diluted shares. Their stock trades at seventy-five dollars per share. TechCore has one billion in cash and eight hundred million in existing debt.

DataFlow is the target with annual revenue of six hundred million dollars and EBITDA of one hundred twenty million. DataFlow is growing revenue at eighteen percent annually versus TechCore's six percent.

The acquisition price is one point eight billion dollars, representing a fifteen times EBITDA multiple and a thirty percent premium to DataFlow's current trading price. The consideration mix is sixty percent cash and forty percent TechCore stock issued at the current seventy-five dollar share price.

Management projects annual cost synergies of eighty million dollars, phased in at twenty percent in year one, sixty percent in year two, and one hundred percent from year three onward. Revenue synergies are estimated at forty million annually, starting at zero in year one, fifty percent in year two, and one hundred percent from year three. Assume a fifty percent flow-through margin on revenue synergies.

Integration costs total ninety million dollars, with sixty million in year one and thirty million in year two. Transaction costs are forty-five million, expensed at close.

To finance the cash portion of the deal, TechCore will use five hundred million from existing cash and raise five hundred eighty million in new senior secured debt at SOFR plus two hundred fifty basis points, assume SOFR at five percent currently. The debt amortizes at five percent annually with a five-year bullet maturity.

For purchase price allocation, assume DataFlow's identifiable net assets have a book value of three hundred million and a fair value of four hundred fifty million. Customer relationships are valued at two hundred million with a ten-year amortization, and developed technology at one hundred twenty million with a five-year amortization.

Both companies have a twenty-one percent tax rate. Build a five-year projection showing accretion/dilution to TechCore EPS each year, synergy realization, debt paydown, and pro forma combined credit metrics. Include sensitivity analysis on synergy achievement and purchase multiple.
```

### Expected Outputs:

| Metric | Expected Value |
|--------|----------------|
| Acquirer Year 0 EPS | $3.20 |
| New Shares Issued | 9.6M |
| Sources Total | $1,845M |
| Uses Total | $1,845M |
| Goodwill | $1,030M |
| Year 1 Interest Expense | $43.5M |
| Year 3 Cost Synergies | $80M |
| Year 3 Rev Synergy EBITDA | $20M (not $40M) |
| Total Tabs | 11 |

If ANY of these values are wrong, you have not fixed the bugs.

---

## FINAL NOTES

1. DO NOT add new features until all bugs are fixed
2. DO NOT change the input format - parse natural language
3. DO NOT hardcode values - use Excel formulas
4. DO test with the exact test case above
5. DO verify all 11 tabs are created
6. DO ensure Sources = Uses exactly

When you have fixed all bugs, the model should pass all validation checks above.