CROSS-CHUNK COHERENCE SYSTEM — COMPLETE IMPLEMENTATION SPEC
DATABASE CONNECTION
Use the Neon PostgreSQL database connected via the environment variable DATABASE_URL. This database already exists and is configured. All coherence state must be stored here. Do not use in-memory storage. Do not use local files.
REQUIRED TABLES (CREATE IF NOT EXIST)
sqlCREATE TABLE IF NOT EXISTS coherence_documents (
    id SERIAL PRIMARY KEY,
    document_id TEXT NOT NULL,
    coherence_mode TEXT NOT NULL,
    global_state JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(document_id, coherence_mode)
);

CREATE TABLE IF NOT EXISTS coherence_chunks (
    id SERIAL PRIMARY KEY,
    document_id TEXT NOT NULL,
    coherence_mode TEXT NOT NULL,
    chunk_index INTEGER NOT NULL,
    chunk_text TEXT,
    evaluation_result JSONB,
    state_after JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(document_id, coherence_mode, chunk_index)
);
PROCESSING SEQUENCE (MANDATORY ORDER)
Step 1: Initialize document run

Generate unique document_id for this text
Determine coherence_mode (user-selected or auto-detect)
Chunk the text into segments ≤1000 words
Process chunks SEQUENTIALLY — never in parallel

Step 2: Process Chunk 0 (first chunk)

Extract initial STATE using the State Template for the selected coherence_mode
Write STATE to coherence_documents table
Write chunk evaluation to coherence_chunks table with chunk_index = 0

Step 3: Process Chunk N (N > 0)

READ current STATE from coherence_documents table
INJECT STATE into the prompt when evaluating chunk N
Evaluate chunk against STATE
UPDATE STATE based on chunk content
WRITE updated STATE back to coherence_documents table
WRITE chunk evaluation to coherence_chunks table with chunk_index = N
THEN and only then proceed to chunk N+1

Step 4: Final output

Read all chunk evaluations from coherence_chunks
Read final STATE from coherence_documents
Generate summary report

STATE TEMPLATES BY COHERENCE MODE
LOGICAL CONSISTENCY
json{
  "mode": "logical_consistency",
  "assertions": [],
  "negations": [],
  "disjoint_pairs": []
}
Track: claims asserted, claims denied, pairs that cannot both be true.
Fail condition: chunk asserts X when negations contains X, or asserts both members of a disjoint pair.
LOGICAL COHESIVENESS
json{
  "mode": "logical_cohesiveness",
  "thesis": "",
  "support_queue": [],
  "current_stage": "setup",
  "bridge_required": ""
}
Track: what argument establishes, what support is promised, current position in argument arc.
Fail condition: thesis restated without advancement, support_queue items never discharged, stage regression without justification.
SCIENTIFIC / EXPLANATORY
json{
  "mode": "scientific_explanatory",
  "causal_nodes": [],
  "causal_edges": [],
  "level": "",
  "active_feedback_loops": [],
  "mechanism_requirements": []
}
Track: variables introduced, causal relationships stated, explanatory level (physical/institutional/behavioral), feedback loops that must remain live.
Fail condition: causal claim made without mechanism, level shifts without bridging, feedback loop introduced then dropped, mechanism replaced by slogan.
THEMATIC / PSYCHOLOGICAL
json{
  "mode": "thematic_psychological",
  "dominant_affect": "",
  "tempo": "",
  "stance": ""
}
Track: emotional register, pacing, analytic vs rhetorical stance.
Fail condition: abrupt unannounced affect shift, tempo reversal without transition.
INSTRUCTIONAL
json{
  "mode": "instructional",
  "goal": "",
  "steps_done": [],
  "prereqs": [],
  "open_loops": []
}
Track: target outcome, steps already given, assumed prerequisites, promised steps not yet delivered.
Fail condition: step requires prereq not yet established, steps out of logical order, open loops never closed.
MOTIVATIONAL
json{
  "mode": "motivational",
  "direction": "",
  "intensity": 0,
  "target": ""
}
Track: encourage/warn/pressure/reassure, intensity 1-5, who is addressed.
Fail condition: direction reversal without justification, intensity swing >2 without transition.
MATHEMATICAL (PROOF VALIDITY)
json{
  "mode": "mathematical",
  "givens": [],
  "proved": [],
  "goal": "",
  "proof_method": "",
  "dependencies": []
}
Track: axioms/assumptions, lemmas established, theorem target, proof strategy, what each step relies on.
Fail condition: uses unproved lemma, circular dependency, method switches without restart.
PHILOSOPHICAL (CONCEPTUAL RIGOR)
json{
  "mode": "philosophical",
  "core_concepts": {},
  "distinctions": [],
  "dialectic": {"objections_raised": [], "replies_pending": []},
  "no_equivocation": []
}
```
Track: key terms with their roles, distinctions drawn, dialectical position, terms that must not change meaning.
Fail condition: term changes meaning silently, distinction collapsed, objection raised but never addressed.

AUTO-DETECT
- Analyze first chunk to determine dominant mode
- Select ONE mode
- Apply that mode's template for entire document
- Do not blend modes

PROMPT STRUCTURE FOR CHUNK EVALUATION

When evaluating chunk N, the prompt must contain:
```
COHERENCE MODE: [selected mode]

CURRENT STATE:
[JSON state retrieved from coherence_documents]

CHUNK TEXT:
[chunk N text]

TASK:
1. Evaluate whether this chunk continues, refines, or breaks the coherence state
2. Identify any state violations with specific locations
3. Propose minimal repairs if violations found
4. Return updated state reflecting this chunk's contributions

OUTPUT FORMAT:
{
  "status": "preserved" | "weakened" | "broken",
  "violations": [{"location": "...", "type": "...", "description": "..."}],
  "repairs": [{"location": "...", "suggestion": "..."}],
  "state_update": {[fields to update in STATE]}
}
EVALUATION CRITERIA BY MODE
Logical Consistency

PASS: no contradiction with prior assertions
FAIL: asserts X when ¬X already asserted

Logical Cohesiveness

PASS: advances argument, discharges support obligations, maintains stage progression
FAIL: restates without advancing, skips required bridges, regresses stage

Scientific / Explanatory

PASS: extends causal graph, maintains level or bridges explicitly, keeps feedback loops active
FAIL: resets to slogan, drops mechanism, changes level without link

Thematic / Psychological

PASS: continues affect or signals transition
FAIL: abrupt mood break, unexplained tempo shift

Instructional

PASS: follows logical step order, respects prereqs
FAIL: assumes unestablished prereqs, skips steps, leaves loops open

Motivational

PASS: maintains direction or escalates/de-escalates smoothly
FAIL: reverses direction, jumps >2 intensity levels

Mathematical

PASS: uses only established lemmas, maintains proof method
FAIL: uses unproved results, circular reasoning

Philosophical

PASS: concepts stable, distinctions maintained, dialectic progressed
FAIL: equivocation, collapsed distinction, unanswered objection

OUTPUT RULES (MANDATORY)

Never return "error", "cannot evaluate", or null
Always return status + violations + repairs + state_update
If no violations, return empty arrays, not nulls
Repairs must be minimal and local — do not rewrite chunks

DATABASE OPERATIONS (EXACT)
Initialize run:
sqlINSERT INTO coherence_documents (document_id, coherence_mode, global_state)
VALUES ($1, $2, $3)
ON CONFLICT (document_id, coherence_mode) 
DO UPDATE SET global_state = $3, updated_at = NOW();
Read state before chunk N:
sqlSELECT global_state FROM coherence_documents
WHERE document_id = $1 AND coherence_mode = $2;
Update state after chunk N:
sqlUPDATE coherence_documents
SET global_state = $1, updated_at = NOW()
WHERE document_id = $2 AND coherence_mode = $3;
Write chunk evaluation:
sqlINSERT INTO coherence_chunks (document_id, coherence_mode, chunk_index, chunk_text, evaluation_result, state_after)
VALUES ($1, $2, $3, $4, $5, $6)
ON CONFLICT (document_id, coherence_mode, chunk_index)
DO UPDATE SET evaluation_result = $5, state_after = $6;
ENFORCEMENT

Chunks must be processed in order: 0, 1, 2, ...
Each chunk must wait for previous chunk's state update before processing
No parallel chunk processing
State must round-trip through database between every chunk
If database read fails, halt and report — do not proceed with stale state